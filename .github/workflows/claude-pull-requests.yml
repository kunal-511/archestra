name: Claude Pull Requests

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

jobs:
  claude-pull-requests:
    name: Claude Pull Requests
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.title, '[WIP]')
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Need full history to compare with base branch
          persist-credentials: true # credentials are needed here as Claude will use them to read stuffs

      - name: Run Claude Code
        uses: anthropics/claude-code-action@28f83620103c48a57093dcc2837eec89e036bb9f # v0.0.63
        with:
          # Dynamically set the secret based on the user who triggered the workflow
          # use their oauth token, since otherwise Anthropic will ban accounts for abuse :(
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          use_sticky_comment: "true"

          # This will allow Claude to edit the PR description
          # See https://github.com/anthropics/claude-code-action/tree/main?tab=readme-ov-file#custom-tools
          allowed_tools: |
            Bash(gh pr edit:*)

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          model: "claude-opus-4-20250514"
          fallback_model: "claude-sonnet-4-20250514"

          # This is an optional setting that allows Claude to read CI results on PRs
          # See https://github.com/anthropics/claude-code-action?tab=readme-ov-file#additional-permissions-for-cicd-integration
          additional_permissions: |
            actions: read

          direct_prompt: |
            Be concise. Keep comments short and clear. Only elaborate if critical issues found.

            Tasks:
            1. Add PR description if the description is currently blank (actually add it, don't just say "add PR description")
            2. Update CLAUDE.md if needed (push a commit to the branch with the changes you are proposing)
            3. Quick review: bugs, security, performance (skip if none found)
